/**
 * Troika - 三进制密码学哈希函数
 *
 * 移植自 Cybercrypt A/S 的 C 参考实现 (MIT License)
 * 原始仓库: https://github.com/Troikahash/reference
 *
 * 状态大小 729 trits (9列 × 3行 × 27切片)，24轮置换，安全级别对标 SHA-3
 */

const COLUMNS = 9;
const ROWS = 3;
const SLICES = 27;
const SLICESIZE = COLUMNS * ROWS;
const STATESIZE = COLUMNS * ROWS * SLICES; // 729
const NUM_SBOXES = (SLICES * ROWS * COLUMNS) / 3;
const NUM_ROUNDS = 24;
const TROIKA_RATE = 243;
const PADDING = 1;

const { bytesToTrits, tritsToBytes } = require('./encoding');

const SBOX_LOOKUP = [
  6, 25, 17, 5, 15, 10, 4, 20, 24,
  0, 1, 2, 9, 22, 26, 18, 16, 14,
  3, 13, 23, 7, 11, 12, 8, 21, 19,
];

const SHIFT_ROWS_PARAM = [0, 1, 2];

const SHIFT_LANES_PARAM = [
  19, 13, 21, 10, 24, 15, 2, 9, 3,
  14, 0, 6, 5, 1, 25, 22, 23, 20,
  7, 17, 26, 12, 8, 18, 16, 11, 4,
];

const ROUND_CONSTANTS = [
  [2,2,2,2,1,2,0,1,0,1,1,0,2,0,1,0,1,1,0,0,1,2,1,1,1,0,0,2,0,2,1,0,2,2,2,1,0,2,2,0,0,1,2,2,1,0,1,0,1,2,2,2,0,1,2,2,1,1,2,1,1,2,0,2,0,2,0,0,0,0,2,1,1,2,1,0,1,0,2,1,1,0,0,2,2,2,2,0,1,1,2,1,2,2,0,1,2,2,2,0,1,0,2,2,0,2,1,1,2,1,2,1,0,0,2,1,0,0,1,2,2,1,1,1,0,1,0,2,2,0,2,2,2,0,2,2,1,0,0,0,2,1,0,0,1,1,1,2,2,1,0,1,0,1,1,1,1,0,1,2,2,1,0,1,0,2,0,1,2,0,1,2,2,2,2,1,0,0,0,0,2,1,0,2,1,1,2,0,2,1,0,0,0,1,0,2,1,2,0,1,2,1,0,2,0,2,1,0,0,1,2,0,2,2,2,0,1,0,2,0,1,0,2,1,2,1,2,2,1,1,2,0,2,2,1,0,0,2,0,2,1,0,1],
  [1,1,1,0,2,2,0,2,0,1,0,2,1,1,0,0,1,1,1,2,0,1,1,2,0,1,1,1,2,0,2,2,2,0,2,1,1,2,1,0,2,1,0,2,1,0,0,2,0,0,0,0,0,0,1,1,0,0,1,0,0,0,1,1,0,2,0,0,0,2,1,1,0,1,2,0,1,2,1,1,1,0,1,0,0,0,1,0,2,2,0,2,0,2,1,0,2,1,0,0,1,2,2,0,0,0,0,1,0,2,2,2,1,1,0,1,0,2,1,2,2,2,1,0,2,2,0,2,0,1,2,1,0,1,0,0,1,1,0,1,2,2,2,0,0,1,0,0,1,2,1,1,1,2,0,0,0,2,1,0,2,1,2,2,1,2,1,0,0,0,2,0,0,0,2,2,1,2,2,0,0,1,2,2,1,0,0,2,1,2,2,2,0,1,1,1,1,2,0,1,1,2,2,1,0,1,2,0,2,2,1,0,1,2,1,0,1,0,1,1,2,1,1,2,2,2,1,0,2,0,0,0,1,1,2,1,0,2,0,1,1,1,2],
  [0,2,0,2,1,2,1,1,2,1,1,2,2,2,2,0,0,0,0,0,1,1,0,1,1,1,0,0,1,1,0,0,0,1,2,2,0,1,0,2,2,1,2,2,2,2,1,2,1,1,0,0,1,0,2,0,2,0,1,2,0,0,2,2,2,1,1,0,0,2,0,2,2,2,2,1,2,1,0,2,0,2,0,2,0,2,2,0,2,2,1,2,1,2,0,0,0,0,1,0,2,1,1,2,1,0,1,0,2,0,1,0,0,2,2,2,2,2,1,1,0,1,2,2,0,0,2,2,1,0,1,2,2,1,0,2,1,1,2,1,2,0,1,0,0,1,0,0,1,1,0,1,0,0,0,0,0,1,0,0,2,0,2,0,0,1,0,0,1,0,2,1,0,2,0,0,0,0,2,0,0,0,2,0,1,0,2,0,0,1,2,0,1,1,2,2,0,2,2,0,0,2,2,1,2,0,0,0,1,0,2,1,0,1,2,1,1,0,2,0,0,2,1,1,0,1,1,2,0,0,1,1,1,0,0,2,2,2,2,1,1,2,2],
  [1,2,2,0,2,2,0,1,0,0,0,2,0,0,0,2,1,0,2,2,0,0,1,2,1,0,0,1,0,1,2,2,1,2,1,0,0,1,1,2,0,0,2,2,1,0,1,2,2,2,0,2,1,1,2,1,2,1,1,0,2,1,0,0,1,2,0,1,1,0,0,1,0,2,0,0,2,0,2,0,0,2,2,0,0,0,2,1,0,0,2,0,1,1,2,1,0,1,1,0,1,2,2,0,2,2,0,0,0,1,2,2,0,0,0,1,1,1,2,2,2,1,1,1,1,1,1,1,1,2,2,2,0,0,0,0,0,1,1,1,1,1,1,0,0,1,1,1,0,0,0,2,2,0,1,1,2,2,2,2,2,0,2,2,2,1,1,0,0,1,0,0,2,2,2,1,2,0,0,0,1,2,2,2,0,1,2,1,1,2,2,1,1,2,0,1,0,0,1,0,2,0,2,0,1,0,0,0,2,2,2,1,1,1,0,2,2,2,2,2,2,2,2,1,1,2,0,0,0,0,0,2,2,0,2,2,1,0,0,2,2,0,0],
  [0,1,1,1,1,2,0,1,1,1,1,1,0,1,2,0,2,1,0,0,2,0,1,0,1,2,0,1,1,0,1,1,1,1,0,0,2,0,0,0,1,0,2,2,1,0,0,1,1,0,2,1,1,1,1,0,1,0,1,0,1,2,0,2,0,2,1,2,1,1,0,1,1,2,2,2,2,0,1,0,0,2,1,1,0,1,2,1,0,1,1,1,1,0,1,1,2,2,0,1,0,2,0,0,2,1,2,2,1,2,2,0,0,1,2,0,0,0,0,2,1,2,2,0,2,1,0,2,1,2,0,2,0,2,0,0,0,2,1,1,1,2,1,0,1,2,1,1,2,1,0,2,2,1,1,0,0,0,2,0,1,1,2,1,2,2,2,0,1,2,2,0,1,0,1,1,2,0,2,2,2,1,1,0,2,2,1,0,2,2,2,1,1,1,1,1,0,1,2,2,2,2,0,0,2,0,1,2,1,0,1,1,0,0,1,0,1,2,2,0,0,2,0,0,1,1,2,2,1,0,0,0,2,1,2,1,0,1,1,2,2,1,2],
  [2,2,2,0,2,1,0,0,0,1,0,1,0,2,0,1,2,1,0,1,2,2,2,1,0,1,2,2,1,2,1,2,1,2,1,2,0,0,2,1,2,1,2,1,1,2,0,1,2,2,1,2,0,0,2,0,0,2,0,0,1,2,0,0,0,0,0,0,2,2,0,2,1,0,0,0,2,2,0,0,2,0,1,2,2,2,0,1,0,0,1,0,2,1,1,2,1,0,0,0,2,0,1,0,0,2,1,2,2,0,1,1,0,1,1,2,0,2,2,2,0,0,0,2,2,1,0,2,1,1,1,2,2,1,1,0,0,1,2,1,1,0,2,1,2,0,2,1,0,1,1,0,2,1,1,2,0,2,0,0,1,0,1,0,2,1,1,0,2,0,1,2,2,0,1,1,1,2,1,0,2,2,2,2,1,1,0,2,0,1,2,0,2,2,1,1,2,1,0,0,1,0,1,2,0,0,2,1,0,0,1,1,0,2,0,1,0,1,0,1,0,1,2,1,1,1,2,1,2,1,1,1,0,2,1,0,1,2,0,2,2,1,0],
  [0,2,1,0,1,0,1,1,1,1,1,0,2,2,1,0,1,0,0,2,1,1,1,1,2,2,0,1,1,1,2,0,1,1,2,2,2,1,1,2,0,2,2,1,1,2,2,0,2,1,0,1,2,0,1,2,0,2,0,2,1,0,0,0,0,1,1,2,2,0,1,2,0,1,1,2,1,2,2,0,0,0,2,2,0,1,0,2,1,1,2,2,0,2,1,2,0,1,0,1,2,0,2,2,1,0,1,1,1,0,1,0,1,1,2,0,1,2,0,2,1,0,2,2,0,0,0,1,2,0,0,1,0,1,1,1,2,0,2,2,0,1,0,1,1,2,1,0,0,2,1,1,0,2,0,2,1,1,1,1,1,1,2,2,2,1,2,0,0,0,1,1,1,2,0,1,2,1,1,1,1,1,2,0,0,1,0,2,0,0,1,2,2,2,0,2,2,0,2,2,2,1,1,0,0,0,0,0,2,2,2,1,2,2,0,0,2,2,2,2,0,0,2,1,0,2,2,0,1,1,0,1,0,0,1,0,2,2,0,0,2,0,0],
  [0,2,1,0,1,0,0,0,1,2,1,0,2,2,0,2,1,2,1,2,0,1,0,0,2,2,2,1,1,0,1,0,1,2,2,2,2,1,0,2,1,1,2,1,0,2,1,0,0,1,0,0,2,0,0,0,1,0,0,0,1,0,0,1,1,0,0,2,1,0,0,0,1,0,2,1,1,0,1,2,1,0,2,0,1,1,0,1,1,2,0,2,1,2,0,0,0,2,2,1,2,2,1,2,1,2,2,1,0,0,0,0,2,1,0,0,1,1,2,0,2,1,0,1,0,1,2,2,1,2,0,2,2,1,1,2,0,0,1,1,0,1,2,0,2,2,2,1,0,0,1,0,1,0,2,2,1,1,0,0,1,2,2,1,1,2,1,2,0,2,2,0,2,0,0,1,1,1,0,0,0,1,0,2,1,1,2,2,2,1,0,2,0,1,0,1,1,2,1,0,2,1,1,1,0,2,0,2,0,0,1,2,2,1,2,2,1,0,2,2,2,0,0,0,0,1,0,1,2,1,1,1,0,1,0,1,1,1,0,2,2,0,2],
  [1,0,1,2,1,1,0,0,2,0,2,1,1,0,1,2,1,0,2,2,1,1,0,1,1,2,0,1,1,2,1,0,0,2,2,0,2,2,0,2,1,1,2,0,0,0,0,0,2,1,0,2,2,1,0,0,2,1,0,0,1,1,1,1,1,1,0,1,0,1,1,0,0,0,2,0,2,1,0,0,2,2,2,0,2,2,0,1,1,2,2,1,0,0,0,2,2,2,1,0,1,1,2,2,2,2,2,1,2,0,2,1,1,0,0,2,0,1,1,2,1,1,2,1,0,1,2,2,0,0,0,0,2,2,1,2,2,1,1,0,2,2,1,0,0,0,2,1,1,1,1,1,1,2,2,1,1,2,0,0,0,1,1,0,2,0,2,2,1,1,1,0,1,2,2,0,1,2,2,2,0,1,2,2,2,0,2,1,1,2,0,2,1,1,0,2,1,0,2,1,2,1,1,1,0,0,0,0,2,2,0,2,2,2,2,0,2,2,0,0,0,2,0,1,0,0,0,1,1,2,0,1,1,0,2,1,1,2,2,0,2,0,1],
  [0,1,0,1,2,0,1,1,1,1,2,1,1,0,0,2,1,0,1,0,0,1,2,1,1,0,2,2,0,0,2,1,0,1,1,1,0,1,0,1,0,2,0,1,2,0,2,1,2,2,2,1,0,0,1,2,2,0,1,2,1,1,0,2,2,2,2,0,1,0,1,1,1,2,0,1,2,1,1,0,1,1,2,0,0,1,0,1,0,0,2,2,2,2,0,1,2,0,1,2,2,0,1,2,0,0,0,0,2,2,2,0,0,2,1,0,2,2,2,1,1,0,1,0,0,1,2,2,2,1,0,2,0,0,2,2,1,2,1,0,2,0,0,2,1,0,2,2,0,2,0,0,1,0,0,1,0,0,1,0,2,0,0,0,0,0,0,0,2,2,0,1,0,0,0,0,2,2,0,2,1,0,2,0,2,2,0,0,2,0,0,2,2,0,0,1,0,0,0,0,2,0,1,2,0,0,2,0,2,0,1,0,0,2,0,0,2,1,1,1,0,1,0,0,0,1,1,2,2,0,2,0,2,1,1,2,1,2,0,1,2,2,1],
  [0,0,1,1,0,0,2,0,1,1,0,1,0,2,1,0,1,2,0,0,2,2,0,0,2,1,0,2,0,2,0,1,0,1,0,0,2,2,1,1,1,1,2,0,1,2,1,2,2,0,1,2,0,0,1,1,0,2,2,0,0,2,2,1,0,1,1,0,1,0,2,1,1,2,0,0,0,2,2,0,1,0,2,2,1,2,2,0,2,1,2,1,1,0,0,2,0,2,2,2,0,1,2,1,0,2,0,2,1,2,0,1,2,0,2,2,2,2,1,0,0,0,1,0,2,0,2,1,1,2,1,0,2,2,2,2,1,0,0,2,0,1,2,0,2,1,1,1,0,1,0,0,1,2,1,2,2,0,2,0,0,2,1,1,0,2,0,1,0,0,1,1,1,1,2,1,1,0,0,1,1,0,1,0,0,1,2,0,1,0,0,2,0,0,2,0,0,1,0,1,0,0,0,0,0,2,0,1,2,0,2,0,0,2,0,1,0,0,1,1,0,0,0,1,1,0,0,1,0,2,2,1,1,0,2,0,0,2,1,1,2,1,1],
  [2,0,0,1,1,0,0,0,0,2,2,2,1,0,2,2,0,2,2,2,2,1,0,1,0,0,0,2,0,2,1,2,2,0,2,2,0,2,2,2,0,2,0,0,0,0,0,2,1,0,1,0,1,0,0,2,1,0,2,2,1,2,0,1,1,0,0,1,1,0,1,0,2,0,2,0,1,0,0,2,2,2,2,1,1,1,0,1,2,2,0,2,2,2,2,0,1,2,2,0,0,2,0,1,2,0,2,2,1,0,0,1,0,0,1,0,1,1,1,0,0,0,0,0,1,0,1,2,2,2,0,0,1,0,1,1,2,1,1,1,2,0,1,0,2,0,0,2,1,2,0,1,2,2,0,0,1,2,1,0,0,2,2,1,2,2,1,2,1,1,2,1,0,0,0,0,2,0,0,0,2,1,2,0,2,0,0,1,2,1,2,1,1,1,0,2,2,1,1,2,0,2,2,1,1,1,2,0,2,1,0,1,2,2,1,2,1,2,0,2,1,2,0,0,2,1,1,1,2,2,1,2,0,1,1,2,1,1,0,0,1,0,2],
  [2,0,0,1,2,0,0,2,1,0,1,2,2,0,2,0,1,0,2,1,2,2,0,1,1,1,2,0,2,0,2,2,2,1,1,2,1,1,2,0,2,2,2,0,0,0,0,2,1,0,2,1,1,1,0,2,1,0,0,0,1,2,2,1,0,0,1,2,1,2,2,0,1,1,0,2,1,1,0,2,2,2,0,1,0,1,1,1,1,2,1,2,1,1,0,1,0,1,0,1,2,0,1,0,2,1,2,1,1,0,0,1,2,0,2,2,0,1,2,0,2,0,1,0,0,2,0,0,1,1,1,1,0,1,0,0,2,1,1,0,2,0,2,0,1,1,1,1,1,2,2,1,1,2,1,0,0,1,1,0,2,0,0,2,1,0,1,0,1,2,0,0,1,0,2,2,1,1,0,2,2,0,2,1,1,2,1,1,1,0,0,2,1,0,0,0,2,2,2,1,1,0,1,2,2,2,2,2,2,1,0,1,2,1,0,0,0,2,1,2,1,1,2,1,2,2,1,2,2,0,0,0,1,0,0,0,0,2,1,1,1,0,0],
  [2,0,2,1,1,2,2,2,1,0,2,2,1,0,1,1,2,1,0,1,1,1,2,0,2,0,2,2,0,1,1,2,1,1,2,0,0,2,2,2,0,0,0,2,2,0,2,2,1,1,1,2,2,0,0,0,1,2,2,1,1,2,1,1,1,2,2,0,2,0,0,0,2,1,1,2,0,1,0,1,2,1,1,0,2,0,1,1,1,1,0,1,1,2,1,2,1,0,2,0,0,2,0,1,2,2,0,2,0,0,0,1,0,2,2,0,1,0,1,1,0,2,1,0,2,1,1,0,0,1,0,0,0,0,1,1,2,0,0,0,2,0,1,1,2,2,2,1,2,0,1,2,2,1,1,2,0,1,0,0,2,0,2,0,2,0,1,0,1,0,2,1,2,1,1,1,1,2,2,0,2,2,0,2,0,1,1,2,0,0,0,0,1,1,2,2,2,2,1,0,1,1,2,1,1,0,2,1,2,0,2,0,0,1,1,0,2,1,1,1,0,2,1,0,1,0,1,2,2,1,0,0,2,2,1,1,2,0,1,1,1,2,1],
  [2,0,2,0,2,1,1,0,1,1,1,1,2,2,1,1,0,0,1,0,1,1,0,2,1,2,0,0,1,0,0,1,0,2,1,2,2,0,0,0,0,2,0,2,0,2,1,1,0,2,0,2,1,2,2,1,1,1,2,2,2,2,0,0,2,2,1,1,1,0,1,1,0,2,1,2,2,2,0,0,0,1,0,2,0,1,1,1,1,1,0,2,2,1,2,1,0,0,2,1,1,1,0,2,2,1,1,1,1,2,2,1,1,1,2,2,0,1,1,0,2,2,1,1,2,2,2,0,1,1,1,2,0,1,1,1,2,2,1,1,2,0,2,1,1,1,0,2,0,2,1,2,1,2,2,1,2,2,2,2,2,1,0,0,0,0,1,0,0,2,1,1,2,0,1,0,0,1,1,1,0,2,0,1,0,0,1,1,2,1,2,1,1,0,0,1,2,0,1,2,0,1,2,0,2,0,0,0,0,0,0,0,1,1,0,1,0,0,0,0,1,1,0,0,2,0,2,0,1,1,0,2,1,0,2,1,1,2,0,1,0,0,0],
  [0,1,0,2,0,1,0,2,0,1,0,2,2,1,1,2,2,1,1,2,1,1,2,0,1,0,2,0,0,0,0,2,0,1,2,2,0,1,0,2,0,1,0,2,2,2,1,2,2,1,1,2,1,2,2,0,0,0,2,0,0,1,0,2,1,1,2,0,0,2,0,2,0,1,0,2,2,0,0,2,1,1,1,2,1,0,1,0,1,1,2,1,0,2,2,2,1,0,2,0,2,0,1,2,2,1,0,2,2,1,1,0,2,0,1,0,1,1,2,1,1,2,1,1,1,0,2,0,0,0,0,0,2,2,1,2,0,1,0,0,2,2,1,0,1,0,1,0,1,2,1,1,2,2,1,2,1,1,1,0,0,1,0,0,2,0,2,2,2,0,0,0,1,0,2,0,2,1,1,1,1,0,2,2,2,2,1,2,0,2,1,1,2,0,2,0,1,1,2,1,0,2,1,1,1,2,2,0,2,0,0,1,2,1,1,2,0,1,0,2,2,1,0,0,2,0,1,2,1,1,1,1,1,0,1,0,1,0,2,0,0,2,0],
  [2,1,2,2,2,0,0,0,2,2,2,0,1,1,1,1,2,2,2,1,2,2,1,0,1,1,1,2,0,0,0,1,2,0,1,1,2,2,1,1,2,0,0,2,2,1,0,2,0,2,2,0,2,1,1,0,2,2,0,0,0,2,1,1,1,1,0,1,1,2,1,1,2,0,2,0,0,2,0,0,0,2,1,1,0,0,0,0,1,2,1,1,1,2,2,0,1,2,1,0,2,1,1,2,2,0,1,2,0,0,1,0,1,2,2,0,0,2,2,0,1,1,2,2,1,0,2,0,2,2,2,1,0,1,0,2,2,0,2,2,1,2,2,2,1,0,0,0,1,0,0,1,2,1,1,2,1,0,0,0,2,1,0,0,0,2,1,2,2,1,0,1,2,2,1,2,0,0,1,2,1,2,0,0,1,2,2,2,1,1,1,2,2,2,2,1,2,2,2,1,1,1,0,2,0,0,1,2,2,2,2,1,2,0,2,2,2,1,0,2,0,1,1,0,2,2,1,0,2,1,2,0,1,1,1,1,0,0,2,1,0,2,1],
  [0,2,2,1,1,0,0,0,0,0,1,1,2,1,2,2,0,0,1,1,2,0,1,0,2,1,2,1,2,2,0,1,2,0,2,2,1,0,2,2,0,0,1,0,1,1,0,1,0,1,2,0,1,0,0,0,2,1,1,0,0,1,0,2,2,1,1,1,2,0,0,2,1,1,2,2,1,2,2,0,1,1,0,1,0,0,0,2,2,2,0,0,2,0,2,2,2,2,1,1,0,0,2,0,2,0,2,2,1,2,1,0,2,1,2,0,1,0,2,2,0,0,2,1,0,1,2,1,0,1,0,1,0,2,1,1,2,2,2,1,2,2,0,1,0,1,1,2,0,0,2,2,1,1,0,2,2,2,0,2,1,2,1,1,1,2,1,0,2,2,2,0,2,1,0,2,0,1,2,1,0,2,0,0,2,1,0,1,2,0,2,0,0,1,0,2,1,0,1,1,0,2,0,2,0,0,2,0,0,1,2,2,1,0,0,0,0,2,2,2,0,1,1,2,0,2,2,2,1,2,2,2,2,1,0,2,2,0,0,1,0,2,1],
  [0,1,0,1,2,0,2,0,0,2,2,1,1,0,1,1,0,0,2,1,2,1,0,0,0,2,1,1,2,2,2,1,2,2,1,1,0,1,1,2,0,0,0,2,1,0,0,2,2,2,1,2,1,0,1,1,2,2,2,0,2,2,2,0,2,1,1,1,0,0,2,1,0,2,1,2,2,2,1,1,0,0,0,2,0,1,2,2,1,2,2,2,0,1,0,2,0,0,0,1,1,2,1,2,2,0,1,1,1,2,0,1,0,2,2,2,1,1,2,0,1,2,1,2,2,2,0,2,0,0,1,1,0,1,1,0,1,0,2,1,0,0,0,0,0,2,2,0,0,1,2,0,0,2,2,0,1,2,2,0,2,0,2,0,2,0,2,2,0,1,2,1,2,1,2,0,0,2,0,1,1,2,1,1,2,0,0,1,2,2,0,0,0,2,2,2,2,2,2,1,1,2,2,2,0,0,0,2,2,0,1,1,1,1,1,2,2,0,2,2,1,0,0,1,1,2,0,0,1,1,1,0,1,2,2,2,2,1,1,2,0,1,2],
  [1,0,2,2,0,2,0,0,1,2,0,1,0,0,1,0,2,2,0,0,1,0,0,0,2,1,0,1,2,0,0,2,2,1,0,2,1,0,2,0,2,1,1,0,0,0,0,2,2,2,1,1,2,2,0,2,2,2,2,2,0,1,2,0,0,2,0,0,1,2,0,0,2,0,0,0,2,2,0,2,0,0,0,1,2,2,0,0,1,0,1,1,2,2,2,1,2,0,1,0,2,1,1,2,0,1,0,1,2,0,1,0,2,0,1,1,1,0,0,1,2,2,1,2,1,2,2,0,2,2,0,0,2,1,0,2,0,0,0,1,0,1,0,0,2,0,1,1,0,1,2,0,1,0,1,2,0,0,1,0,0,1,1,1,0,2,2,0,0,0,1,1,2,1,1,0,1,1,1,1,2,0,0,1,0,0,1,0,1,2,2,2,0,0,0,0,1,1,2,1,1,1,1,0,1,1,2,0,0,2,0,2,0,0,2,2,2,0,0,2,1,0,0,2,2,1,1,0,1,0,1,1,2,1,2,1,0,2,1,0,2,0,1],
  [2,2,0,0,0,0,2,1,0,2,2,1,1,0,2,1,0,0,1,1,2,1,1,0,0,1,0,1,2,0,0,1,2,0,0,1,1,0,2,2,2,0,2,2,1,0,1,1,2,1,0,0,1,1,2,0,2,0,2,1,0,1,2,2,1,1,2,2,0,2,1,2,0,2,0,1,2,0,2,2,1,1,1,1,0,0,1,0,1,2,2,0,2,2,0,0,1,1,2,2,0,0,0,1,2,1,2,1,2,1,1,1,2,1,1,2,1,2,0,2,1,0,0,0,0,1,1,1,2,0,1,2,0,1,1,1,1,2,0,0,0,0,2,1,0,1,2,2,1,0,2,1,0,2,1,2,0,1,0,0,0,0,0,2,1,0,1,0,2,0,0,2,1,0,2,2,2,2,0,0,1,0,0,1,2,0,1,1,2,0,0,0,2,0,0,2,2,2,2,1,2,0,0,0,2,2,0,2,0,1,2,1,2,2,0,0,1,1,0,1,1,0,2,1,2,1,0,0,0,0,1,0,2,2,2,1,2,0,1,0,2,1,2],
  [2,0,1,0,1,2,0,2,0,2,2,1,1,1,0,1,1,2,0,1,2,2,2,0,0,2,2,0,0,2,1,1,1,0,2,0,1,0,1,1,2,2,1,2,1,1,1,0,2,1,0,0,2,0,2,2,1,0,0,1,1,0,2,0,1,1,1,0,1,0,1,2,1,2,1,2,0,2,1,1,1,1,2,1,1,1,2,1,2,0,1,0,0,2,1,0,1,1,0,1,0,1,1,0,2,0,0,0,2,1,0,0,1,2,0,1,2,1,0,1,0,2,0,0,0,1,2,2,2,2,2,0,1,1,2,2,1,0,0,1,2,2,2,1,0,1,1,0,2,2,1,2,1,2,0,0,1,1,1,0,2,1,1,2,2,1,1,2,1,0,1,0,1,0,2,0,0,2,2,2,1,2,2,2,0,0,2,2,2,0,0,1,1,1,0,2,2,1,1,2,1,1,2,1,1,1,2,0,0,0,0,0,0,2,1,2,2,1,0,0,0,2,1,2,0,0,1,1,2,2,1,2,1,2,2,1,2,1,0,0,2,1,0],
  [0,0,2,2,1,1,1,0,1,2,2,2,1,2,2,2,0,1,2,1,2,0,0,1,1,2,0,1,1,1,2,2,1,2,2,0,2,1,1,1,0,0,0,2,0,2,1,2,2,2,2,2,0,2,2,2,0,1,0,0,1,0,0,2,1,2,1,0,0,0,0,1,1,2,2,2,1,2,0,1,1,2,1,1,2,0,1,0,2,2,0,0,0,2,0,1,2,1,0,1,1,2,0,1,0,1,2,2,0,2,2,0,1,1,1,2,2,0,0,0,2,2,1,1,1,2,1,1,2,2,1,2,2,1,0,0,0,1,0,0,0,0,1,1,2,1,0,0,2,0,1,1,2,0,2,1,1,0,1,2,2,2,1,2,1,1,0,1,2,1,2,0,2,0,1,0,1,1,1,1,1,1,1,1,1,0,1,0,0,0,0,0,0,2,0,2,0,2,0,0,0,2,0,2,1,2,1,0,1,2,0,2,2,2,2,2,2,1,0,1,0,2,0,0,0,2,1,2,2,2,2,0,1,2,1,2,0,1,0,1,2,0,1],
  [1,1,0,1,1,1,0,0,2,1,2,0,0,1,2,2,1,1,2,1,2,2,2,2,0,2,0,0,1,0,1,0,1,0,1,0,2,0,1,2,1,2,1,2,2,2,1,0,1,1,2,1,0,1,2,1,2,0,2,0,2,2,1,1,1,1,1,1,2,0,1,2,2,0,0,0,1,2,0,0,2,2,1,1,1,2,0,2,0,2,1,2,2,1,2,1,1,2,2,2,0,0,0,2,0,0,1,1,1,1,1,2,0,0,2,1,1,0,0,1,2,2,0,1,1,1,2,0,2,2,2,2,2,1,1,2,1,0,2,0,0,2,2,0,0,2,0,2,0,0,2,0,1,0,0,2,1,0,0,0,1,1,0,1,1,0,1,2,1,1,0,0,0,0,0,1,1,0,1,2,2,0,0,1,1,0,0,1,2,2,1,2,1,0,2,0,2,2,0,0,2,2,0,2,2,0,0,1,0,2,0,0,0,0,1,2,0,2,2,0,1,0,1,2,0,1,0,0,2,1,1,1,0,0,1,0,1,1,1,2,2,2,0],
];

function subTrytes(state) {
  for (let i = 0; i < NUM_SBOXES; i++) {
    const idx = 3 * i;
    const input = 9 * state[idx] + 3 * state[idx + 1] + state[idx + 2];
    let output = SBOX_LOOKUP[input];
    state[idx + 2] = output % 3;
    output = Math.floor(output / 3);
    state[idx + 1] = output % 3;
    output = Math.floor(output / 3);
    state[idx] = output % 3;
  }
}

function shiftRows(state) {
  const newState = new Uint8Array(STATESIZE);
  for (let slice = 0; slice < SLICES; slice++) {
    for (let row = 0; row < ROWS; row++) {
      for (let col = 0; col < COLUMNS; col++) {
        const oldIdx = SLICESIZE * slice + COLUMNS * row + col;
        const newCol = (col + 3 * SHIFT_ROWS_PARAM[row]) % COLUMNS;
        const newIdx = SLICESIZE * slice + COLUMNS * row + newCol;
        newState[newIdx] = state[oldIdx];
      }
    }
  }
  state.set(newState);
}

function shiftLanes(state) {
  const newState = new Uint8Array(STATESIZE);
  for (let slice = 0; slice < SLICES; slice++) {
    for (let row = 0; row < ROWS; row++) {
      for (let col = 0; col < COLUMNS; col++) {
        const oldIdx = SLICESIZE * slice + COLUMNS * row + col;
        const newSlice = (slice + SHIFT_LANES_PARAM[col + COLUMNS * row]) % SLICES;
        const newIdx = SLICESIZE * newSlice + COLUMNS * row + col;
        newState[newIdx] = state[oldIdx];
      }
    }
  }
  state.set(newState);
}

function addColumnParity(state) {
  const parity = new Uint8Array(SLICES * COLUMNS);
  for (let slice = 0; slice < SLICES; slice++) {
    for (let col = 0; col < COLUMNS; col++) {
      let sum = 0;
      for (let row = 0; row < ROWS; row++) {
        sum += state[SLICESIZE * slice + COLUMNS * row + col];
      }
      parity[COLUMNS * slice + col] = sum % 3;
    }
  }
  for (let slice = 0; slice < SLICES; slice++) {
    for (let row = 0; row < ROWS; row++) {
      for (let col = 0; col < COLUMNS; col++) {
        const idx = SLICESIZE * slice + COLUMNS * row + col;
        const sumToAdd =
          parity[((col - 1 + 9) % 9) + COLUMNS * slice] +
          parity[((col + 1) % 9) + COLUMNS * ((slice + 1) % SLICES)];
        state[idx] = (state[idx] + sumToAdd) % 3;
      }
    }
  }
}

function addRoundConstant(state, round) {
  for (let slice = 0; slice < SLICES; slice++) {
    for (let col = 0; col < COLUMNS; col++) {
      const idx = SLICESIZE * slice + col;
      state[idx] = (state[idx] + ROUND_CONSTANTS[round][slice * COLUMNS + col]) % 3;
    }
  }
}

function troikaPermutation(state, numRounds) {
  for (let round = 0; round < numRounds; round++) {
    subTrytes(state);
    shiftRows(state);
    shiftLanes(state);
    addColumnParity(state);
    addRoundConstant(state, round);
  }
}

function troikaAbsorb(state, rate, message, numRounds) {
  let offset = 0;
  let remaining = message.length;

  while (remaining >= rate) {
    for (let i = 0; i < rate; i++) {
      state[i] = message[offset + i];
    }
    troikaPermutation(state, numRounds);
    remaining -= rate;
    offset += rate;
  }

  // Pad last block
  const lastBlock = new Uint8Array(rate);
  for (let i = 0; i < remaining; i++) {
    lastBlock[i] = message[offset + i];
  }
  lastBlock[remaining] = PADDING;

  for (let i = 0; i < rate; i++) {
    state[i] = lastBlock[i];
  }
}

function troikaSqueeze(hashLen, rate, state, numRounds) {
  const hash = new Uint8Array(hashLen);
  let offset = 0;
  let remaining = hashLen;

  while (remaining >= rate) {
    troikaPermutation(state, numRounds);
    for (let i = 0; i < rate; i++) {
      hash[offset + i] = state[i];
    }
    offset += rate;
    remaining -= rate;
  }

  if (remaining > 0) {
    troikaPermutation(state, numRounds);
    for (let i = 0; i < remaining; i++) {
      hash[offset + i] = state[i];
    }
  }

  return hash;
}

/**
 * Troika 哈希 - 输入 trit 数组，输出 trit 数组
 * @param {Uint8Array|number[]} input - trit 数组 (值为 0, 1, 2)
 * @param {number} outputLen - 输出 trit 长度 (默认 243)
 * @returns {Uint8Array} - 哈希结果 trit 数组
 */
function troikaTrits(input, outputLen = 243) {
  const state = new Uint8Array(STATESIZE);
  const msg = input instanceof Uint8Array ? input : new Uint8Array(input);
  troikaAbsorb(state, TROIKA_RATE, msg, NUM_ROUNDS);
  return troikaSqueeze(outputLen, TROIKA_RATE, state, NUM_ROUNDS);
}

/**
 * Troika 哈希 - 输入字节数据，输出字节数据
 * 内部: 字节 → trit → Troika → trit → 字节
 * @param {Buffer} data - 输入字节数据
 * @returns {Buffer} - 32字节哈希结果
 */
function troika(data) {
  const trits = bytesToTrits(data);
  const hashTrits = troikaTrits(trits, 192); // 192 trits = 32 bytes
  return Buffer.from(tritsToBytes(hashTrits));
}

module.exports = {
  troika,
  troikaTrits,
  troikaPermutation,
  STATESIZE,
  TROIKA_RATE,
  NUM_ROUNDS,
};
